machine:
  ruby:
    version: 2.1.2
  node:
    version: 0.12.2
test:
  override:
    - npm install microtime@latest --save && npm test
    - git clone git@github.com:pelias/acceptance-tests
    - echo "{\"mapzen\":{\"api_key\":{\"pelias.mapzen.com\":\"$SEARCH_API_KEY\",\"pelias.mapzen.com\":\"$PELIAS_API_KEY\"}}}" >~/pelias.json
    - cd acceptance-tests && npm install microtime@latest --save && npm install && npm test -- -e prod
deployment:
  prod_build:
    branch: production
    commands:
      - git clone git@github.com:mapzen/pelias-deploy.git
      - cd pelias-deploy && bundle install && bundle exec rake deploy:api[prod_build]
  prod:
    branch: production
    commands:
      - git clone git@github.com:mapzen/pelias-deploy.git
      - cd pelias-deploy && bundle install && bundle exec rake deploy:api[prod]
